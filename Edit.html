<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° - PBNTC Activity System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
    <script>
    // üí° ‡πÄ‡∏û‡∏¥‡πà‡∏° Flatpickr ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Time Picker ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö .flatpickr-time)
    flatpickr(".flatpickr-time", {
        enableTime: true,
        noCalendar: true,
        time_24hr: true,
        dateFormat: "H:i", // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö
        altInput: true,
        altFormat: "H:i ‡∏ô.", // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏°‡∏µ "‡∏ô.")
        minuteIncrement: 1,
        locale: "th" // ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    });
</script>

    <style>
        /* CSS ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ (‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ) */
        /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
body {
    margin: 0;
    font-family: Tahoma, sans-serif;
    background-color: #f4f4f4;
}

/* Header (‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏µ‡∏™‡πâ‡∏°) */
.header {
    background-color: #d9534f; /* ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏≠‡∏°‡πÅ‡∏î‡∏á */
    color: white;
    padding: 10px 20px;
    height: 60px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ logo ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö sidebar */
    box-sizing: border-box;
}

.logo-area {
    font-size: 24px;
    font-weight: bold;
    display: flex;
    align-items: center;
}

.logo {
    width: 40px;
    height: 40px;
    margin-right: 10px;
    border-radius: 50%;
    /* ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏à‡∏£‡∏¥‡∏á */
}

/* ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å (Sidebar + Content) */
.main-container {
    display: flex;
    min-height: calc(100vh - 60px); /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ ‡∏•‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á Header */
}

/* Sidebar (‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏™‡∏µ‡∏î‡∏≥) */
.sidebar {
    width: 200px;
    background-color: #333; /* ‡∏™‡∏µ‡∏î‡∏≥/‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏° */
    color: white;
    padding-top: 20px;
    flex-shrink: 0;
}

.sidebar a {
    display: block;
    color: #ccc;
    padding: 15px 20px;
    text-decoration: none;
    border-left: 5px solid transparent;
    transition: all 0.2s;
}

.sidebar a:hover {
    color: white;
    background-color: #444;
}

.sidebar a.Edit_Active {
    color: white;
    background-color: #444;
    border-left-color: #d9534f; /* ‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ */
}

.sidebar a i {
    margin-right: 10px;
    width: 20px; /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô */
}

/* Content (‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å) */
.content {
    flex-grow: 1;
    padding: 40px;
    background-color: white;
}

/* ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤ */
.time-display {
    text-align: center;
    font-size: 18px;
    color: #666;
    margin-bottom: 40px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

/* Function Grid (‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô) */
.function-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
    gap: 30px;
    max-width: 900px;
    margin: 0 auto;
}

/* Function Block (‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏≠‡∏±‡∏ô) */
.function-block {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 180px;
    text-align: center;
    color: white;
    font-size: 20px;
    font-weight: bold;
    border-radius: 8px;
    text-decoration: none;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.function-block:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
}

.function-block i {
    font-size: 60px;
    margin-bottom: 15px;
}

/* --- Styles for Confirmation Dialog (Modal) --- */

/* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏°‡∏∑‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ Dialog ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏î‡∏≥‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

/* ‡∏ï‡∏±‡∏ß Modal ‡∏´‡∏•‡∏±‡∏Å */
.modal-dialog {
    background-color: white;
    border-radius: 4px;
    width: 450px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    overflow: hidden;
}

/* ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß (‡∏™‡∏µ‡∏™‡πâ‡∏°) */
.modal-header {
    background-color: #f0ad4e; /* ‡∏™‡∏µ‡∏™‡πâ‡∏° */
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: bold;
}

.modal-header h3 {
    margin: 0;
}

.modal-header .close-btn {
    font-size: 24px;
    cursor: pointer;
    line-height: 1;
}

/* ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ */
.modal-body {
    padding: 30px 20px;
    text-align: center;
    font-size: 16px;
    color: #333;
}

.modal-body #activityToDeleteName {
    color: #d9534f; /* ‡πÄ‡∏ô‡πâ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏µ‡πÅ‡∏î‡∏á */
    font-weight: bold;
}

/* ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢ (‡∏õ‡∏∏‡πà‡∏°) */
.modal-footer {
    padding: 15px 20px;
    text-align: right;
    display: flex;
    justify-content: center;
    gap: 20px;
}

/* üìå Styles ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏°‡∏µ‡∏™‡∏µ) */
.btn {
    padding: 10px 25px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.2s;
    font-weight: bold;
}

.btn-cancel {
    background-color: #5bc0de; /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤ */
    color: white;
}

.btn-confirm {
    background-color: #d9534f; /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á */
    color: white;
}

/* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á */
.function-block.blue { background-color: #337ab7; } /* ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° - ‡∏™‡∏µ‡∏ü‡πâ‡∏≤ */
.function-block.red { background-color: #d9534f; }    /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° */
.function-block.green { background-color: #5cb85c; }  /* ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° - ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
.function-block.orange { background-color: #f0ad4e; } /* ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤ */
.function-block.purple { background-color: #673ab7; } /* ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÄ‡∏ó‡∏≠‡∏° */


/* *** START: CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤) ***
*/

.page-title { /* ‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô .content-header */
    font-size: 26px;
    font-weight: bold;
    margin-bottom: 20px;
    color: #333; /* ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ò‡∏µ‡∏°‡∏´‡∏•‡∏±‡∏Å */
}

/* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    text-align: left;
}

.data-table th, .data-table td {
    padding: 10px 12px;
    border: 1px solid #ddd;
    font-size: 15px;
}

.data-table th {
    background-color: #f2f2f2;
    color: #333;
    font-weight: 600;
    text-align: center;
    border-bottom: 2px solid #ccc;
}

.data-table tr:nth-child(even) {
    background-color: #f7f7f7;
}

/* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°/‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
.pass { color: #5cb85c; font-weight: 600; } /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
.fail { color: #d9534f; font-weight: 600; } /* ‡πÅ‡∏î‡∏á */
.role-select { width: 120px; padding: 5px; border-radius: 4px; } /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Department_information.html */

/* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Filter / Search */
.filter-controls {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    align-items: center;
}

.filter-controls input[type="text"],
.filter-controls select {
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 15px;
    box-sizing: border-box;
}

.search-box {
    position: relative;
    flex: 1; /* ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î */
}

.search-box input {
    width: 100%;
    padding-left: 35px; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô */
}

.search-box i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #777;
}

.filter-controls label {
    font-weight: bold;
    white-space: nowrap;
}

/* *** END: CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤) ***
*/
        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            gap: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 250px;
        }
        .form-group input, .form-group select {
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
            width: 100%;
        }
        .required::before {
            content: '*';
            color: #d9534f;
            margin-right: 5px;
        }
        .time-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .create-button {
            background-color: #5bc0de;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
        }
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏ô input */
        .input-icon-group {
            position: relative;
            width: 100%;
        }
        .input-icon-group input {
            padding-right: 35px;
        }
        .input-icon-group i {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
            pointer-events: none;
        }
       .attendance-table {
    border-collapse: collapse;
    width: 100%;
    font-family: Arial, sans-serif;
}

.attendance-table th, .attendance-table td {
    text-align: center;
    padding: 8px 5px;
}

.attendance-table tbody tr:nth-child(odd) {
    background-color: #fff;
}
.attendance-table tbody tr:nth-child(even) {
    background-color: #f2f2f2;
}

.attendance-table thead th {
    border-bottom: 2px solid #333;
}

/* ‡∏ã‡πà‡∏≠‡∏ô radio button ‡∏à‡∏£‡∏¥‡∏á */
.attendance-table input[type="radio"] {
    display: none;
}

/* ‡∏õ‡∏∏‡πà‡∏° default ‡∏ß‡πà‡∏≤‡∏á */
.attendance-table label {
    display: inline-block;
    width: 40px;
    height: 30px;
    border: 2px solid #ccc;
    border-radius: 4px;
    cursor: pointer;
    position: relative;
}
/* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó */
.attendance-table label.present-btn {
    border-color: green; /* ‡∏°‡∏≤ */
}

.attendance-table label.late-btn {
    border-color: goldenrod; /* ‡∏™‡∏≤‡∏¢ */
}

.attendance-table label.absent-btn {
    border-color: red; /* ‡∏Ç‡∏≤‡∏î */
}

/* ‡∏™‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
input[type="radio"]:checked + label.present-btn {
    background-color: green;
    border-color: green;
}
input[type="radio"]:checked + label.late-btn {
    background-color: #f1c40f; /* ‡∏û‡∏∑‡πâ‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á */
    border-color: goldenrod;
    color: white; /* ‡∏™‡∏µ text ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô label (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ ::after) */
    position: relative; /* ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ ::after ‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ */
}
input[type="radio"]:checked + label.absent-btn {
    background-color: red;
    border-color: red;
}

/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
input[type="radio"]:checked + label::after {
    content: "‚úî";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: bold;
    font-size: 16px;
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢ (‡∏û‡∏∑‡πâ‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á) */
input[type="radio"]:checked + label.late-btn::after {
    content: "‚úî";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white; /* ‡∏™‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å */
    font-weight: bold;
    font-size: 16px;
    z-index: 1; /* ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
    pointer-events: none; /* ‡πÑ‡∏°‡πà‡∏Ç‡∏±‡∏î‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å */
}
    </style>
</head>
<body>
   <div class="header">
            <div class="logo-area">
                <img src="pbntc-logo.png" alt="PBNTC Logo" class="logo">
                PBNTC
            </div>
        </div>
    
    <div class="main-container">
        <div class="sidebar">
            <nav>
                <a href="index.html"><i class="fas fa-home"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
                <a href="create_activity.html" ><i class="fas fa-edit"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</a>
                <a href="edit_delete_activity.html" class="Edit_Active"><i class="fas fa-list-alt"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</a>
                <a href="#"><i class="fas fa-clipboard-check"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</a>
                <a href="#"><i class="fas fa-building"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤</a>
                <a href="summary.html"><i class="fas fa-poll"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÄ‡∏ó‡∏≠‡∏°</a>
                <a href="#" class="logout"><i class="fas fa-sign-out-alt"></i> ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏Å</a>
            </nav>
        </div>

        <div class="content">
            <h2 class="page-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h2>

            <form id="createActivityForm">
                <div class="form-row">
                    <div class="form-group" style="width: 100%;">
                        <label for="activityName" class="required">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                        <input type="text" id="activityName" name="activityName" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="activityDate" class="required">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                        <div class="input-icon-group">
                            <input type="text" id="activityDate" name="activityDate" placeholder="‡∏ß‡∏ß/‡∏î‡∏î/‡∏õ‡∏õ‡∏õ‡∏õ" required>
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                    </div>

                     <div class="form-group">
                            <label for="startTime" class="required">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                            <div class="input-icon-group">
                                <input type="text" id="startTime"
                                    name="startTime" required
                                    class="flatpickr-time"
                                    placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="endTime" class="required">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                            <div class="input-icon-group">
                                <input type="text" id="endTime"
                                    name="endTime" required
                                    class="flatpickr-time"
                                    placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="department">‡∏™‡∏≤‡∏Ç‡∏≤</label>
                        <div class="input-icon-group">
                            <select id="department" name="department">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                                <option value="1">‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</option>
                                <option value="2">‡∏ä‡πà‡∏≤‡∏á‡∏¢‡∏ô‡∏ï‡πå</option>
                            </select>
                            <i class="fas fa-check"></i>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="level" >‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                        <div class="input-icon-group">
                            <select id="level" name="level">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</option>
                                <option value="‡∏õ‡∏ß‡∏ä.">‡∏õ‡∏ß‡∏ä.</option>
                                <option value="‡∏õ‡∏ß‡∏™.">‡∏õ‡∏ß‡∏™.</option>
                            </select>
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                        <div class="form-group">
                            <label for="semester" class="required">‡πÄ‡∏ó‡∏≠‡∏°</label>
                            <select id="semester" name="semester" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏≠‡∏°</option>
                                <option value="1">‡πÄ‡∏ó‡∏≠‡∏° 1</option>
                                <option value="2">‡πÄ‡∏ó‡∏≠‡∏° 2</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="studentYear" class="required">‡∏õ‡∏µ</label>
                            <select id="studentYear" name="studentYear" required>
                                <option value>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="studentClass">‡∏´‡πâ‡∏≠‡∏á</label>
                            <select id="studentClass" name="studentClass">
                                <option value>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
                            </select>
                        </div>
                    </div>
                <div class="form-row">
                    <div class="form-group" style="flex: unset; width: 300px; flex-direction: row; align-items: center;">
                        <label for="recurringDays" style="width: 100px; font-weight: normal; margin-right: 10px;">‡∏à‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ</label>
                        <input type="number" id="recurringDays" name="recurringDays" value="0" style="width: 80px;">
                        <span style="font-weight: bold; margin-left: 10px;">‡∏ß‡∏±‡∏ô</span>
                    </div>
                </div>
            <div>
    <table class="attendance-table">
        <thead>
            <tr>
                <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                <th>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
                <th>‡∏°‡∏≤</th>
                <th>‡∏Ç‡∏≤‡∏î</th>
            </tr>
        </thead>
        <tbody>
            <tr>
            </tr>
            <tr>
                
            </tr>
            <tr>
                
            </tr>
        </tbody>
    </table>
</div>

                <button type="submit" class="create-button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>

            </form>
        </div>
    </div>
    <script>
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ flatpickr ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö date picker
        flatpickr("#activityDate", {
            dateFormat: "d/m/Y",
            locale: "th"
        });
    </script>

<script>
/* ====== CONFIG ====== */
const SUPABASE_URL = 'https://pdqzkejlefozxquptoco.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkcXprZWpsZWZvenhxdXB0b2NvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNDIyODAsImV4cCI6MjA3NzkxODI4MH0.EojnxNcGPj7eGlf7FAJOgMuEXIW54I2NQwB_L2Wj9DU';
const supabaseCilent = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // from included supabase script

const params = new URLSearchParams(window.location.search);
const activityId = params.get('activityId');

/* ====== HELPERS ====== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
let allMajors = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
let allClassesData = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Class ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

function setValue(id, value) {
    const el = document.getElementById(id);
    if (!el) return;
    el.value = value ?? '';
}

function formatDateToDisplay(d) {
    if (!d) return '';
    return new Date(d).toLocaleDateString('th-TH');
}
function formatTimeISO(d) {
    if (!d) return '';
    // üí° ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô HH:MM (‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô dateFormat)
    return new Date(d).toISOString().slice(11,16); 
}
function pad(n) { return String(n).padStart(2,'0'); }

function parseDisplayDateToISO(display) {
    // expect DD/MM/YYYY or D/M/YYYY
    if (!display) return null;
    const parts = display.split('/');
    if (parts.length !== 3) return null;
    const [dd, mm, yyyy] = parts.map(p => p.trim());
    return `${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`;
}

/* ====== LOADERS / RENDER ====== */

async function loadMajorList(selectedMajorId = null) {
    try {
        const { data: depts, error } = await supabaseCilent
            .from('major')
            .select('id,name,level')
            .order('name');

        if (error) throw error;

        const deptSelect = $('#department');
        deptSelect.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>`;
        depts.forEach(d => {
            const option = document.createElement('option');
            option.value = d.id;
            option.textContent = `${d.name} (${d.level})`;
            deptSelect.appendChild(option);
        });

        if (selectedMajorId) deptSelect.value = selectedMajorId;
    } catch (err) {
        console.error('loadMajorList error', err);
    }
}

async function loadStudentYears(majorId) {
    if (!majorId) return [];
    try {
        // ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å table class ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° major_id ‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
        const { data, error } = await supabaseCilent
            .from('class')
            .select('year')
            .eq('major_id', majorId)
            .order('year', { ascending: true });

        if (error) throw error;
        const years = [...new Set((data || []).map(r => r.year))].filter(Boolean).sort();
        return years;
    } catch (err) {
        console.error('loadStudentYears error', err);
        return [];
    }
}
async function fetchAllMajorsAndClasses() {
    const { data: majors, error: majorError } = await supabaseCilent
        .from('major')
        .select('id, name, level');
    if (majorError) { console.error('Error fetching majors:', majorError.message); return []; }
    allMajors = majors;
    
    // ‡∏î‡∏∂‡∏á Classes ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown ‡∏õ‡∏µ/‡∏´‡πâ‡∏≠‡∏á)
    const { data: classes, error: classError } = await supabaseCilent
        .from('class')
        .select('id, class_name, major_id, year, class_number');
    if (classError) { console.error('Error fetching classes:', classError.message); return []; }
    allClassesData = classes;
}
function updateDepartmentOptions(selectedLevel, currentMajorId) {
    const departmentSelect = document.getElementById('department');
    departmentSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>';

    if (!selectedLevel) return;

    const filteredMajors = allMajors.filter(m => m.level === selectedLevel);
    filteredMajors.forEach(m => {
        const option = document.createElement('option');
        option.value = m.id;
        option.textContent = m.name;
        if (m.id === currentMajorId) {
            option.selected = true;
        }
        departmentSelect.appendChild(option);
    });
}
function updateYearOptions(selectedLevel, currentYear) {
    const yearSelect = document.getElementById('studentYear');
    yearSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</option>';

    if (!selectedLevel) return;

    // Hardcode ‡∏õ‡∏µ‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ (‡∏õ‡∏ß‡∏ä: 1,2,3 / ‡∏õ‡∏ß‡∏™: 1,2)
    let years = [];
    if (selectedLevel === '‡∏õ‡∏ß‡∏ä.') {
        years = [1, 2, 3];
    } else if (selectedLevel === '‡∏õ‡∏ß‡∏™.') {
        years = [1, 2];
    }

    years.forEach(y => {
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y;
        if (y === currentYear) {
            option.selected = true;
        }
        yearSelect.appendChild(option);
    });
}
async function loadClassesFor(majorId, year) {
    if (!majorId || !year) return [];
    try {
        const { data, error } = await supabaseCilent
            .from('class')
            .select('id,class_number,class_name')
            .eq('major_id', majorId)
            .eq('year', year)
            .order('class_number', { ascending: true });

        if (error) throw error;
        return data || [];
    } catch (err) {
        console.error('loadClassesFor error', err);
        return [];
    }
}

function attachRadioToggleBehavior(container = document) {
    // allow uncheck by clicking again
    container.querySelectorAll('input[type="radio"]').forEach(radio => {
        if (radio.dataset.listenerAttached === "true") return;
        radio.addEventListener('click', function (event) {
            if (this.dataset.waschecked === "true") {
                event.preventDefault();
                const that = this;
                setTimeout(() => {
                    that.checked = false;
                    that.dataset.waschecked = "false";
                }, 0);
            } else {
                const group = container.querySelectorAll(`input[name="${this.name}"]`);
                group.forEach(r => r.dataset.waschecked = "false");
                this.dataset.waschecked = "true";
            }
        });
        radio.dataset.listenerAttached = "true";
    });
}

async function loadAttendanceTable(activityIdLocal) {
    const tableBody = document.querySelector('.attendance-table tbody');
    tableBody.innerHTML = '';

    try {
        const { data, error } = await supabaseCilent
            .from('activity_check')
            .select('id,semester,student:student_id (id,name),status,date,academic_year')
            .eq('activity_id', activityIdLocal)
            .order('student_id', { ascending: true });

        if (error) throw error;
        const statusMap = { 'Attended':'present', 'Absent':'absent', 'Excused':'late' };

        data.forEach((record) => {
            const indexId = record.id;
            const studentName = record.student?.name || '-';
            const studentId = record.student?.id || '-';
            const status = statusMap[record.status] || '';

            const tr = document.createElement('tr');
            tr.dataset.recordId = record.id;

            // use stable unique radio name so selection never collides
            const radioName = `status_${record.id}`;

            tr.innerHTML = `
                <td style="text-align:left; padding-left:8px">${studentName}</td>
                <td>${studentId}</td>
                <td>
                    <input type="radio" name="${radioName}" id="present_${indexId}" value="present" ${status==='present' ? 'checked':''}>
                    <label for="present_${indexId}" class="present-btn"></label>
                </td>
                <td>
                    <input type="radio" name="${radioName}" id="absent_${indexId}" value="absent" ${status==='absent' ? 'checked':''}>
                    <label for="absent_${indexId}" class="absent-btn"></label>
                </td>
            `;
            tableBody.appendChild(tr);
        });

        attachRadioToggleBehavior(tableBody);
    } catch (err) {
        console.error('loadAttendanceTable error', err);
    }
}

/* ====== ACTIONS ====== */
async function loadActivity() {
    if (!activityId) {
        console.warn('No activityId in URL');
        return;
    }

    try {
        const { data: activity, error } = await supabaseCilent
            .from('activity')
            .select(`id, name, start_time, end_time, is_recurring, class_id,class:class_id (class_number,major:major_id (id,name,level)
            )`)
            .eq('id', activityId)
            .single();

        if (error) throw error;

        // set fields
        setValue('activityName', activity.name || '');
        // detect activity_check date first
        const { data: activity_check, error: actErr } = await supabaseCilent
            .from('activity_check')
            .select('date,semester')
            .eq('activity_id', activityId)
            .limit(1);

        let initialDate = null;
        if (!actErr && activity_check && activity_check.length > 0) {
            initialDate = activity_check[0].date;
            initialSemester = activity_check[0].semester; // expect YYYY-MM-DD
        } else {
            initialDate = activity.start_time;
        }

        // flatpickr (re-initialize safely)
        if (window.flatpickr) {
            try {
                // destroy if exists
                if (window._activityDatePicker && typeof window._activityDatePicker.destroy === 'function') {
                    window._activityDatePicker.destroy();
                }
                // convert to Date if possible
                const defaultDate = initialDate ? new Date(initialDate) : null;
                window._activityDatePicker = flatpickr("#activityDate", {
                    dateFormat: "d/m/Y",
                    locale: "th",
                    defaultDate: defaultDate
                });
            } catch (e) {
                console.warn('flatpickr init failed', e);
            }
        } else {
            // fallback: set value as display
            setValue('activityDate', formatDateToDisplay(initialDate));
        }

        // set time fields (ISO->hh:mm)
        setValue('startTime', activity.start_time ? formatTimeISO(activity.start_time) : '');
    setValue('endTime', activity.end_time ? formatTimeISO(activity.end_time) : '');
        setValue('recurringDays', activity.is_recurring ? 1 : 0);
        await fetchAllMajorsAndClasses();
        // load majors list and select
        await loadMajorList(activity.major?.id);
        if (activity.major) {
            // set level if present
            setValue('level', activity.major.level || '');
        }
        if (initialSemester) {
            const semesterSelect = document.getElementById('semester');
            semesterSelect.value = initialSemester;
        }
        // load student years from class
        const majorId = activity.major?.id;
        if (majorId) {
            const years = await loadStudentYears(majorId);
            const yearSelect = $('#studentYear');
            yearSelect.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</option>`;
            years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                yearSelect.appendChild(opt);
            });
            if (years.length > 0) yearSelect.value = years[0];
            // also load classes for default selection
            await fetchStudentClass(); // will read current department/year
        }
        if (majorData) {
            setValue('level', majorData.level || '');
            
            // üí° ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Populate Dropdown
            updateDepartmentOptions(majorData.level, majorData.id); // Populate Major ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
            updateYearOptions(majorData.level, initialYear); // Populate Year ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°

            // üí° ‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á (Class) ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
            await fetchStudentClass(initialClassId); 
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ major_id ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î Dropdown ‡∏ß‡πà‡∏≤‡∏á
            updateDepartmentOptions('', null);
            updateYearOptions('', null);
        }

        // load attendance rows
        await loadAttendanceTable(activityId);

    } catch (err) {
        console.error('loadActivity error', err);
    }
}

async function fetchStudentYear() {
    // general loader for all years (not filtered)
    try {
        const { data, error } = await supabaseCilent
            .from('class')
            .select('year')
            .order('year');

        if (error) throw error;

        const uniqueYears = [...new Set((data || []).map(r => r.year))].sort();
        const yearSelect = $('#studentYear');
        if (!yearSelect) return;
        yearSelect.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</option>`;
        uniqueYears.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = y;
            yearSelect.appendChild(opt);
        });
    } catch (err) {
        console.error('fetchStudentYear error', err);
    }
}

async function fetchStudentClass(currentClassId = null) {
    const majorId = document.getElementById('department').value;
    const year = document.getElementById('studentYear').value;
    const classSelect = document.getElementById('studentClass');
    classSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>';

    if (!majorId || !year) return;
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Classes ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const filteredClasses = allClassesData.filter(c => 
        c.major_id.toString() === majorId.toString() && c.year.toString() === year.toString()
    );

    filteredClasses.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = c.class_name ? c.class_name : `‡∏´‡πâ‡∏≠‡∏á ${c.class_number}`;
        if (c.id.toString() === currentClassId?.toString()) {
            option.selected = true;
        }
        classSelect.appendChild(option);
    });
}

/* ====== FORM SUBMIT ====== */
const form = document.getElementById('createActivityForm');
if (form) {
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        // read fields
        const activityName = document.getElementById('activityName').value.trim();
        const activityDateDisplay = document.getElementById('activityDate').value.trim();
        const isoDate = parseDisplayDateToISO(activityDateDisplay); // YYYY-MM-DD
        if (!isoDate) { alert('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }

        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        const start_time_iso = `${isoDate}T${startTime}:00`;
        const end_time_iso = `${isoDate}T${endTime}:00`;

        const majorId = document.getElementById('department').value || null;
        const recurringDays = parseInt(document.getElementById('recurringDays').value || '0', 10);
        const semester = parseInt(document.getElementById('semester').value || '0', 10);
        const academicYear = parseInt(document.getElementById('studentYear').value || '0', 10);
        const classId = document.getElementById('studentClass').value || null;
        if (!semester || !academicYear) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤');
            return;
        }

        // update activity
        const activityData = {
            name: activityName,
            start_time: start_time_iso,
            end_time: end_time_iso,
            for_student: true,
            for_leader: true,
            for_teacher: false,
            is_recurring: (recurringDays > 0) ? recurringDays : null,
            created_by: 1,
            class_id: classId ? parseInt(classId, 10) : null
        };

        try {
            const { data: updatedActivity, error: updateError } = await supabaseCilent
                .from('activity')
                .update(activityData)
                .eq('id', activityId)
                .select('id')
                .single();

            if (updateError) throw updateError;

            // update rows
            const rows = Array.from(document.querySelectorAll('.attendance-table tbody tr'));
            const formattedDate = isoDate; // YYYY-MM-DD
            const statusMap = { present:'Attended', absent:'Absent' };

            for (const row of rows) {
                const recordId = row.dataset.recordId;
                if (!recordId) continue;
                const checked = row.querySelector('input[type="radio"]:checked');
                const statusValue = checked ? checked.value : null;
                if (!statusValue) continue; // skip if user didn't set

                const supaStatus = statusMap[statusValue] || null;
                if (!supaStatus) continue;

                const { error } = await supabaseCilent
                    .from('activity_check')
                    .update({
                        status: supaStatus,
                        date: formattedDate,
                        semester: semester,
                        academic_year: academicYear
                    })
                    .eq('id', recordId);

                if (error) {
                    throw error;
                }
            }

            alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
            // reload attendance table to reflect updates
            await loadAttendanceTable(activityId);

        } catch (err) {
            console.error('submit error', err);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (err.message || JSON.stringify(err)));
        }
    });
}

/* ====== INIT ====== */
document.addEventListener('DOMContentLoaded', async () => {
    // wire events
    document.getElementById('level')?.addEventListener('change', async (e) => {
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Level ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Years ‡πÅ‡∏•‡∏∞ Classes
        const majorId = document.getElementById('department').value;
        const years = await loadStudentYears(majorId);
        const yearSelect = $('#studentYear');
        yearSelect.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</option>`;
        years.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = y;
            yearSelect.appendChild(opt);
        });
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Year ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
        await fetchStudentClass();
    });

    document.getElementById('department')?.addEventListener('change', async (e) => {
        // when department change -> reload years and classes
        const majorId = e.target.value;
        const years = await loadStudentYears(majorId);
        const yearSelect = $('#studentYear');
        yearSelect.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</option>`;
        years.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = y;
            yearSelect.appendChild(opt);
        });
        if (years.length > 0) yearSelect.value = years[0];
        await fetchStudentClass();
    });
    document.getElementById('studentYear')?.addEventListener('change', fetchStudentClass);
    
    // üí° ‡πÄ‡∏û‡∏¥‡πà‡∏° Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Level (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ) ‡πÅ‡∏•‡∏∞ Class Number
    // (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
    document.getElementById('level')?.addEventListener('change', async () => {
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Level ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô: ‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î MajorList ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const majorSelect = document.getElementById('department');
        await loadMajorList(majorSelect.value); // ‡πÇ‡∏´‡∏•‡∏î Major ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏° Level
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Department change ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Year/Class ‡∏ï‡πà‡∏≠‡πÑ‡∏õ
        majorSelect.dispatchEvent(new Event('change')); 
    });
    
    document.getElementById('studentClass')?.addEventListener('change', async () => {
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Class ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ (‡πÅ‡∏Ñ‡πà‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ)
    });

    document.getElementById('studentYear')?.addEventListener('change', fetchStudentClass);

    // initial loading
    await loadActivity();
});


</script>



</body>
</html>